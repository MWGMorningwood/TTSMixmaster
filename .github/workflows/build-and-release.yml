name: Build and Release TTSMixmaster

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: true
        type: boolean
        default: true

env:
  PYTHON_VERSION: "3.11"
  PROJECT_NAME: "TTSMixmaster"

jobs:
  build:
    runs-on: windows-latest
    
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      artifacts: ${{ steps.artifacts.outputs.artifacts }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version
      id: get_version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = $env:GITHUB_REF_NAME
        }
        $version = $version -replace '^v', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: pwsh
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
      shell: pwsh
    
    - name: Update version in pyproject.toml
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $content = Get-Content pyproject.toml -Raw
        $content = $content -replace 'version = "[^"]*"', "version = `"$version`""
        Set-Content pyproject.toml -Value $content
        echo "Updated version to $version in pyproject.toml"
      shell: pwsh
    - name: Create version file
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $content = "__version__ = `"$version`""
        New-Item -Path "src" -ItemType Directory -Force
        Set-Content -Path "src/__version__.py" -Value $content -Encoding utf8
      shell: pwsh
    
    - name: Build with PyInstaller
      run: |
        pyinstaller main.py --clean --noconfirm
        if (-not (Test-Path "dist\TTSMixmaster\TTSMixmaster.exe")) {
          throw "Build failed - executable not found"
        }
        echo "Build completed successfully"
      shell: pwsh
    
    - name: Verify build
      run: |
        $exePath = "dist\TTSMixmaster\TTSMixmaster.exe"
        if (Test-Path $exePath) {
          $fileInfo = Get-Item $exePath
          echo "Executable size: $($fileInfo.Length) bytes"
          echo "Executable created: $($fileInfo.CreationTime)"
        } else {
          throw "Executable not found at $exePath"
        }
      shell: pwsh
    
    - name: Set up Inno Setup
      run: |
        $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $output = "innosetup.exe"
        Invoke-WebRequest -Uri $url -OutFile $output
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
      shell: pwsh
    
    - name: Create MSI installer
      run: |
        $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
        if (-not (Test-Path $innoPath)) {
          throw "Inno Setup not found at $innoPath"
        }
        & $innoPath "installer\TTSMixmaster.iss"
        
        # Find the created installer
        $installerPattern = "dist\TTSMixmaster-Setup-*.exe"
        $installer = Get-ChildItem $installerPattern | Select-Object -First 1
        if ($installer) {
          echo "Installer created: $($installer.Name)"
          echo "installer_path=$($installer.FullName)" >> $env:GITHUB_OUTPUT
        } else {
          throw "Installer not created"
        }
      shell: pwsh
      id: create_installer
    
    - name: Sign executable with Azure Trusted Signing
      uses: azure/trusted-signing-action@v0.4.0
      with:
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        endpoint: ${{ secrets.AZURE_TRUSTED_SIGNING_ENDPOINT }}
        trusted-signing-account-name: ${{ secrets.AZURE_TRUSTED_SIGNING_ACCOUNT }}
        certificate-profile-name: ${{ secrets.AZURE_CERTIFICATE_PROFILE_NAME }}
        files-folder: dist\TTSMixmaster
        files-folder-filter: exe
        files-folder-recurse: false
        files-folder-depth: 1
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
    
    - name: Sign installer with Azure Trusted Signing
      uses: azure/trusted-signing-action@v0.4.0
      with:
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        endpoint: ${{ secrets.AZURE_TRUSTED_SIGNING_ENDPOINT }}
        trusted-signing-account-name: ${{ secrets.AZURE_TRUSTED_SIGNING_ACCOUNT }}
        certificate-profile-name: ${{ secrets.AZURE_CERTIFICATE_PROFILE_NAME }}
        files-folder: dist
        files-folder-filter: exe
        files-folder-recurse: false
        files-folder-depth: 1
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
    
    - name: Create ZIP archive
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipName = "TTSMixmaster-v$version-Portable.zip"
        Compress-Archive -Path "dist\TTSMixmaster\*" -DestinationPath "dist\$zipName"
        echo "zip_path=dist\$zipName" >> $env:GITHUB_OUTPUT
        echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
      shell: pwsh
      id: create_zip
    
    - name: Set artifacts output
      id: artifacts
      run: |
        $installer = Get-ChildItem "dist\TTSMixmaster-Setup-*.exe" | Select-Object -First 1
        $zip = "${{ steps.create_zip.outputs.zip_path }}"
        
        $artifacts = @{
          installer_path = $installer.FullName
          installer_name = $installer.Name
          zip_path = $zip
          zip_name = "${{ steps.create_zip.outputs.zip_name }}"
        } | ConvertTo-Json -Compress
        
        echo "artifacts=$artifacts" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: TTSMixmaster-Build-v${{ steps.get_version.outputs.version }}
        path: |
          dist/TTSMixmaster-Setup-*.exe
          dist/TTSMixmaster-v*-Portable.zip
          dist/TTSMixmaster/
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: TTSMixmaster-Build-v${{ needs.build.outputs.version }}
        path: ./artifacts
    
    - name: Generate changelog
      id: changelog
      run: |
        VERSION="v${{ needs.build.outputs.version }}"
        
        # Get the previous tag
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^$VERSION$" | head -n1)
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous tag found, using initial commit"
          PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        
        echo "Generating changelog from $PREVIOUS_TAG to $VERSION"
        
        # Generate changelog
        CHANGELOG=$(cat << 'EOF'
        ## What's Changed
        
        EOF
        )
        
        # Get commits since last tag
        COMMITS=$(git log --pretty=format:"* %s (%h)" $PREVIOUS_TAG..HEAD)
        
        if [ -n "$COMMITS" ]; then
          CHANGELOG="$CHANGELOG
        
        ### Commits:
        $COMMITS"
        else
          CHANGELOG="$CHANGELOG
        
        * Initial release"
        fi
        
        # Add build information
        CHANGELOG="$CHANGELOG
        
        ## Downloads
        
        - **TTSMixmaster-Setup-v${{ needs.build.outputs.version }}.exe** - Windows installer (recommended)
        - **TTSMixmaster-v${{ needs.build.outputs.version }}-Portable.zip** - Portable version
        
        ## Installation
        
        ### Windows Installer
        1. Download the \`.exe\` installer
        2. Run as administrator if prompted
        3. Follow the installation wizard
        4. Launch TTSMixmaster from the Start Menu
        
        ### Portable Version
        1. Download the \`.zip\` file
        2. Extract to a folder of your choice
        3. Run \`TTSMixmaster.exe\`
        
        ## System Requirements
        
        - Windows 10 or later (64-bit)
        - 100MB free disk space
        - Internet connection for Last.fm integration
        
        ## Notes
        
        - Both executables are digitally signed with Azure Trusted Signing
        - First-time users should check the [documentation](https://github.com/${{ github.repository }}/tree/main/docs) for setup instructions
        - Report issues on the [GitHub Issues](https://github.com/${{ github.repository }}/issues) page"
        
        # Save changelog to file and output
        echo "$CHANGELOG" > changelog.md
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.build.outputs.version }}
        name: TTSMixmaster v${{ needs.build.outputs.version }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
        files: |
          ./artifacts/TTSMixmaster-Setup-*.exe
          ./artifacts/TTSMixmaster-v*-Portable.zip      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update latest release info
      run: |
        echo "âœ… Release v${{ needs.build.outputs.version }} created successfully!"
        echo "ðŸ”— View release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build.outputs.version }}"
